name: UHRH Security Scans

on:
  schedule:
    - cron: '0 0 * * 1' # Weekly on Monday
  push:
    branches: [ main ]
  pull_request:
    branches: [ '*' ]

env:
  HIPAA_CRITICAL_CVSS: 7.0
  FHIR_VERSION: R4

jobs:
  dependency-scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: OWASP Dependency Scan
      uses: dependency-check/action@v2
      with:
        project: 'UHRH-Healthcare'
        format: 'HTML'
        fail_on_cvss: ${{ env.HIPAA_CRITICAL_CVSS }}
        additional_arguments: '--enableExperimental --disableOssIndex'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload Dependency Report
      uses: actions/upload-artifact@v3
      with:
        name: dependency-scan-report
        path: dependency-check-report.html

  container-scan:
    runs-on: ubuntu-latest
    needs: dependency-scan
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Docker image
      run: docker build -t uhri-backend ./backend
      
    - name: Trivy Container Scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'uhri-backend'
        format: 'sarif'
        severity: 'HIGH,CRITICAL'
        scanners: 'vuln,config,secret'
        ignore-unfixed: true
        exit-code: '1'
        vuln-type: 'os,library'
    
    - name: Check for PHI in Images
      run: |
        docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
        ghcr.io/securecontainers/phi-scanner:latest \
        --image uhri-backend \
        --fail-on-phi

  fhir-validation:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate FHIR Resources
      uses: docker://hapiproject/hapi-fhir:6.4.0
      with:
        args: fhir validate --fhir-version=${{ env.FHIR_VERSION }} --file=backend/tests/fhir-resources/*.json
        
    - name: Check PHI in FHIR Data
      run: |
        pip install fhir-parser
        python scripts/check_phi.py ./backend/tests/fhir-resources/

  code-scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Semgrep SAST
      uses: returntocorp/semgrep-action@v1
      with:
        config: p/security-audit
        severity: 'ERROR'
        exclude: '**/node_modules/**'
    
    - name: Check for Hardcoded Secrets
      uses: gitleaks/gitleaks-action@v2
      with:
        config-path: .gitleaks.toml
        redact: true
        
  compliance-check:
    runs-on: ubuntu-latest
    needs: [dependency-scan, container-scan, fhir-validation, code-scan]
    steps:
    - uses: actions/checkout@v4
    
    - name: HIPAA Compliance Audit
      uses: hipaa-compliance/action@v2
      with:
        controls: '164.308,164.312'
        report-format: 'pdf'
        strict-mode: true
        
    - name: Upload Compliance Report
      uses: actions/upload-artifact@v3
      with:
        name: hipaa-compliance-report
        path: hipaa-compliance-report.pdf
        
    - name: Fail if Critical Issues
      if: ${{ failure() }}
      run: |
        echo "::error::Critical security/compliance issues found"
        exit 1